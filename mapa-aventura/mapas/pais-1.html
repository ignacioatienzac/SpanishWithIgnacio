<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../../language-init.js"></script>
    <title>Nivel 1: Bah√≠a de las Vocales</title>
    <link rel="icon" type="image/png" href="../../images/favicon.png">
    <link rel="stylesheet" href="../../style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@900&family=Montserrat:wght@400;700&family=Oswald:wght@500&family=Roboto:wght@300&display=swap" rel="stylesheet">
    <script src="../../script.js" defer></script>
    <style>
        body {
            margin: 0;
            background-color: #2b3e50; /* Mismo azul oc√©ano */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            overflow: hidden;
            gap: 20px;
            padding: 10px 0 20px;
            box-sizing: border-box;
        }

        main {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #level-map-container {
            position: relative;
            width: 1200px;
            max-width: calc(100vw - 40px);
            height: calc(100vh - 200px);
            max-height: calc(100vh - 200px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border-radius: 20px;
            overflow: hidden;
            background: radial-gradient(circle, #4a69bd 0%, #2b3e50 100%);
        }

        /* Bot√≥n de volver */
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 30px;
            text-decoration: none;
            color: #2b3e50;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 100;
            border: 2px solid #2b3e50;
            transition: transform 0.2s;
        }
        .back-btn:hover { transform: scale(1.05); }

        /* SVG Ajustado */
        svg {
            width: 100%;
            height: 100%;
            /* El drop-shadow da sensaci√≥n de isla flotante */
            filter: drop-shadow(0px 20px 30px rgba(0,0,0,0.4)); 
        }

        /* Terreno */
        .land-mass {
            fill: #eebb99;
            stroke: #8d6e63;
            stroke-width: 1px; /* M√°s fino porque estamos "zoomeados" */
            stroke-linejoin: round;
        }

        /* Elementos decorativos del terreno (monta√±as, √°rboles simples) */
        .decoration {
            fill: #cd8c5c; /* Un tono m√°s oscuro de tierra */
            opacity: 0.4;
            pointer-events: none;
        }

        /* Elementos de escenario */
        .tree-canopy {
            fill: #62b36f;
            stroke: #3f7c47;
            stroke-width: 1px;
        }
        .tree-trunk {
            fill: #8d6e63;
        }
        .lake {
            fill: #5dade2;
            stroke: #2980b9;
            stroke-width: 1px;
            opacity: 0.85;
        }

        /* El camino */
        .path-connector {
            fill: none;
            stroke: #fff;
            stroke-width: 2px;
            stroke-dasharray: 5, 5;
            opacity: 0.6;
            pointer-events: none;
        }

        /* --- NODOS DE NIVEL --- */
        .level-node {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-box: fill-box;
            transform-origin: center;
        }

        .level-circle {
            fill: #ffd86b;
            stroke: #c47a1c;
            stroke-width: 2px;
            r: 7; /* Radio del c√≠rculo */
            filter: drop-shadow(0 2px 0 #8a4d0f) drop-shadow(0 3px 6px rgba(0,0,0,0.35));
        }

        .level-number {
            font-size: 6px;
            font-weight: bold;
            fill: #2c3e50;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
        }

        /* ESTADOS DE LOS NIVELES */
        
        /* 1. Completado (Verde) */
        .level-node.completed .level-circle {
            fill: #64e38a;
            stroke: #1f7f43;
        }
        .level-node.completed .level-number { fill: white; }

        /* 2. Actual / Disponible (Amarillo pulsante) */
        .level-node.current .level-circle {
            fill: #ffef7a;
            stroke: #f5a623;
            stroke-width: 3px;
        }
        .level-node.current { 
            animation: pulse 2s infinite;
        }

        .level-node.unlock-effect {
            animation: unlockGrow 0.9s ease-out, unlockPulse 0.6s ease-out 0.9s 1;
        }

        /* 3. Bloqueado (Gris) */
        .level-node.locked {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .level-node.locked .level-circle {
            fill: #d1d5d8;
            stroke: #7f8c8d;
        }

        /* 4. Jefe Final (Nivel 10) */
        .level-node.boss .level-circle {
            r: 11; /* M√°s grande */
            fill: #ff7f7f;
            stroke: #c0392b;
        }
        .level-node.boss .level-number { font-size: 9px; fill: white; }

        /* Efecto Hover */
        .level-node:not(.locked):hover {
            transform: scale(1.5); /* Crece bastante */
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes unlockGrow {
            0% { transform: scale(0.9); }
            60% { transform: scale(1.35); }
            100% { transform: scale(1); }
        }

        @keyframes unlockPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); }
            100% { transform: scale(1); }
        }

        /* Panel de Informaci√≥n del Nivel */
        #level-panel {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 220px;
            background: white;
            padding: 14px;
            border-radius: 14px;
            border: 2px solid #f1c40f;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            display: none;
            animation: slideUp 0.25s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(12px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .btn-play {
            width: 100%;
            padding: 14px 10px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-play:hover { background: #219150; }
        .btn-play:disabled,
        .btn-play.btn-play--disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .hero-character {
            transition: transform 0.3s ease;
        }

        .hero-token {
            transition: x 1s ease-in-out, y 1s ease-in-out;
            pointer-events: none;
        }

        .hero-token--no-transition {
            transition: none !important;
        }

        /* Bot√≥n temporal para simular victoria y avanzar niveles */
        .simulate-victory-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 12px 18px;
            border: none;
            border-radius: 10px;
            background: rgba(39, 174, 96, 0.95);
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
            z-index: 200;
        }
        .simulate-victory-btn:hover {
            background: rgba(33, 150, 83, 0.95);
            transform: translateY(-2px);
        }

    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <div class="logo">
                <span class="logo-main">Spanish with</span>
                <span class="logo-script">Ignacio</span>
            </div>

            <div class="language-switcher language-switcher--mobile">
                <button class="language-switcher__button" type="button" aria-expanded="false" aria-haspopup="listbox" data-language-toggle>
                    <span class="language-switcher__flag" aria-hidden="true">üá™üá∏</span>
                    <span class="language-switcher__chevron" aria-hidden="true">‚ñæ</span>
                    <span class="language-switcher__sr-label">Espa√±ol</span>
                </button>
                <div class="language-switcher__menu" role="listbox" aria-hidden="true">
                    <button class="language-switcher__option" type="button" role="option" aria-selected="false" data-language-option="es" aria-label="Espa√±ol">
                        <span class="language-switcher__option-flag" aria-hidden="true">üá™üá∏</span>
                        <span class="language-switcher__sr-label">Espa√±ol</span>
                    </button>
                    <button class="language-switcher__option" type="button" role="option" aria-selected="false" data-language-option="en" aria-label="English">
                        <span class="language-switcher__option-flag" aria-hidden="true">üá¨üáß</span>
                        <span class="language-switcher__sr-label">English</span>
                    </button>
                </div>
            </div>

            <button class="menu-toggle" aria-expanded="false" aria-controls="primary-navigation" aria-label="Open navigation menu">
                <span class="menu-toggle__bar"></span>
                <span class="menu-toggle__bar"></span>
                <span class="menu-toggle__bar"></span>
            </button>
            <nav class="main-nav" id="primary-navigation">
                <ul>
                    <li><a href="../../index.html">Home</a></li>
                    <li><a href="../../students/index.html">Students</a></li>
                    <li><a href="../../games/index.html">Games</a></li>
                    <li><a href="../../adivina-la-palabra/index.html">Guess the word</a></li>
                    <li class="language-switcher language-switcher--desktop">
                        <button class="language-switcher__button" type="button" aria-expanded="false" aria-haspopup="listbox" data-language-toggle>
                            <span class="language-switcher__flag" aria-hidden="true">üá™üá∏</span>
                            <span class="language-switcher__chevron" aria-hidden="true">‚ñæ</span>
                            <span class="language-switcher__sr-label">Espa√±ol</span>
                        </button>
                        <div class="language-switcher__menu" role="listbox" aria-hidden="true">
                            <button class="language-switcher__option" type="button" role="option" aria-selected="false" data-language-option="es" aria-label="Espa√±ol">
                                <span class="language-switcher__option-flag" aria-hidden="true">üá™üá∏</span>
                                <span class="language-switcher__sr-label">Espa√±ol</span>
                            </button>
                            <button class="language-switcher__option" type="button" role="option" aria-selected="false" data-language-option="en" aria-label="English">
                                <span class="language-switcher__option-flag" aria-hidden="true">üá¨üáß</span>
                                <span class="language-switcher__sr-label">English</span>
                            </button>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div id="level-map-container">
        
        <a href="../index.html" class="back-btn">‚Üê Volver al mapa principal</a>

        <!-- 
            VIEWBOX MAGIA:
            El viewBox original era "0 0 1000 700".
            El Pa√≠s 1 est√° aproximadamente entre X:50-250 y Y:450-650.
            Ajustamos el viewBox para hacer "zoom" en esa zona: "30 440 240 240".
            Esto hace que el pa√≠s ocupe todo el contenedor.
        -->
        <svg viewBox="30 440 240 240" xmlns="http://www.w3.org/2000/svg">
            
            <!-- La Tierra (Mismo path que el archivo anterior) -->
            <path class="land-mass" d="M 50 600 L 200 650 L 250 500 L 150 450 L 50 500 Z" />

            <!-- Decoraci√≥n simple: Unos tri√°ngulos como monta√±as/√°rboles integrados -->
            <path class="decoration" d="M 80 580 L 90 560 L 100 580 Z" />
            <path class="decoration" d="M 180 600 L 190 580 L 200 600 Z" />
            <path class="decoration" d="M 140 480 L 150 460 L 160 480 Z" />

            <!-- √Årboles y lagos simples -->
            <g class="tree">
                <rect class="tree-trunk" x="110" y="610" width="6" height="10" />
                <circle class="tree-canopy" cx="113" cy="606" r="8" />
                <circle class="tree-canopy" cx="118" cy="608" r="7" />
            </g>
            <g class="tree">
                <rect class="tree-trunk" x="205" y="545" width="6" height="10" />
                <circle class="tree-canopy" cx="208" cy="541" r="8" />
                <circle class="tree-canopy" cx="213" cy="543" r="7" />
            </g>
            <g class="tree">
                <rect class="tree-trunk" x="155" y="520" width="6" height="9" />
                <circle class="tree-canopy" cx="158" cy="516" r="7" />
                <circle class="tree-canopy" cx="163" cy="518" r="6" />
            </g>

            <ellipse class="lake" cx="95" cy="500" rx="12" ry="7" />

            <!-- CONECTOR DE CAMINO (Dashed Line) -->
            <!-- Conecta las coordenadas de los 10 puntos -->
            <path class="path-connector" d="
                M 82 520
                L 112 550
                L 92 590
                L 142 610
                L 192 620
                L 212 570
                L 232 520
                L 202 490
                L 162 470
                L 132 480
            " />

            <!-- 
                NIVELES (PUNTOS)
                Coordenadas calculadas para estar dentro de la forma.
            -->

            <!-- Nivel 1: Disponible al iniciar -->
            <text x="82" y="510" class="level-number">1</text>
            <g class="level-node current" data-level="1" onclick="selectLevel(1, 'Inicio del Viaje')">
                <circle cx="82" cy="520" r="6" class="level-circle" />
            </g>

            <!-- Nivel 2: Bloqueado inicialmente -->
            <text x="112" y="540" class="level-number">2</text>
            <g class="level-node locked" data-level="2" onclick="selectLevel(2, 'El Sendero Bajo')">
                <circle cx="112" cy="550" r="6" class="level-circle" />
            </g>

            <!-- Nivel 3: Bloqueado inicialmente -->
            <text x="92" y="580" class="level-number">3</text>
            <g class="level-node locked" data-level="3" onclick="selectLevel(3, 'Cruce de Vientos')">
                <circle cx="92" cy="590" r="6" class="level-circle" />
            </g>

            <!-- Nivel 4: Bloqueado -->
            <text x="142" y="600" class="level-number">4</text>
            <g class="level-node locked" data-level="4" onclick="selectLevel(4, 'Cueva Oscura')">
                <circle cx="142" cy="610" r="6" class="level-circle" />
            </g>

            <!-- Nivel 5 -->
            <text x="192" y="610" class="level-number">5</text>
            <g class="level-node locked" data-level="5" onclick="selectLevel(5, 'Mirador Sur')">
                <circle cx="192" cy="620" r="6" class="level-circle" />
            </g>

            <!-- Nivel 6 -->
            <text x="212" y="560" class="level-number">6</text>
            <g class="level-node locked" data-level="6" onclick="selectLevel(6, 'El Puente')">
                <circle cx="212" cy="570" r="6" class="level-circle" />
            </g>

            <!-- Nivel 7 -->
            <text x="232" y="510" class="level-number">7</text>
            <g class="level-node locked" data-level="7" onclick="selectLevel(7, 'Paso Estrecho')">
                <circle cx="232" cy="520" r="6" class="level-circle" />
            </g>

            <!-- Nivel 8 -->
            <text x="202" y="480" class="level-number">8</text>
            <g class="level-node locked" data-level="8" onclick="selectLevel(8, 'Lago Escondido')">
                <circle cx="202" cy="490" r="6" class="level-circle" />
            </g>

            <!-- Nivel 9 -->
            <text x="162" y="460" class="level-number">9</text>
            <g class="level-node locked" data-level="9" onclick="selectLevel(9, 'Ante la Puerta')">
                <circle cx="162" cy="470" r="6" class="level-circle" />
            </g>

            <!-- Nivel 10: JEFE -->
            <text x="132" y="470" class="level-number">10</text>
            <g class="level-node locked boss" data-level="10" onclick="selectLevel(10, 'GUARDI√ÅN DE LA BAH√çA')">
                <circle cx="132" cy="480" r="10" class="level-circle" />
            </g>

            <image
                id="hero-token"
                class="hero-character hero-token"
                href="../personajes/Protagonista-1.png"
                x="82"
                y="580"
                width="20"
                height="20"
            />

        </svg>

        <!-- Panel Flotante de Informaci√≥n -->
        <div id="level-panel">
            <button id="btn-action" class="btn-play" onclick="startPuzzle()">Jugar este nivel</button>
        </div>

    </div>

    <button class="simulate-victory-btn" onclick="completeCurrentLevel()">Simular Victoria</button>
    </main>

    <footer class="site-footer">
        <div class="site-footer__content">
            <div class="site-footer__section site-footer__section--contact">
                <p class="site-footer__contact">Para colaboraciones o reportar errores, escr√≠beme a <a class="site-footer__contact-link" href="mailto:spanishwithignacio@gmail.com">spanishwithignacio@gmail.com</a>.</p>
            </div>
            <div class="site-footer__section site-footer__section--brand">
                <p class="site-footer__brand">Spanish with Ignacio</p>
            </div>
            <div class="site-footer__section site-footer__section--social" aria-label="Redes sociales">
                <a class="site-footer__social-link" href="https://www.instagram.com/spanishwithignacio/" target="_blank" rel="noopener noreferrer">
                    <img src="../../images/instagram_logo.png" alt="Instagram" class="site-footer__social-icon">
                </a>
                <a class="site-footer__social-link" href="https://www.youtube.com/@SpanishwithIgnacio" target="_blank" rel="noopener noreferrer">
                    <img src="../../images/youtube_logo.png" alt="YouTube" class="site-footer__social-icon">
                </a>
                <a class="site-footer__social-link" href="https://www.facebook.com/people/Spanish-With-Ignacio/61560429119394/" target="_blank" rel="noopener noreferrer">
                    <img src="../../images/facebook_logo.png" alt="Facebook" class="site-footer__social-icon">
                </a>
                <a class="site-footer__social-link" href="https://www.threads.com/@spanishwithignacio?igshid=NTc4MTIwNjQ2YQ==" target="_blank" rel="noopener noreferrer">
                    <img src="../../images/threads_logo.png" alt="Threads" class="site-footer__social-icon">
                </a>
            </div>
        </div>
    </footer>

    <script>
        const LEVEL_STORAGE_KEY = 'wordleQuestCurrentLevel';
        const LAST_COMPLETED_STORAGE_KEY = 'wordleQuestLastCompletedLevel';
        const TRANSITION_END_STORAGE_KEY = 'wordleQuestTransitionEnd';
        const LAST_PLAYED_STORAGE_KEY = 'wordleQuestLastPlayedLevel';
        const ADVENTURE_TRANSITION_DURATION_MS = 700;
        let currentSelectedLevel = null;
        let heroCurrentLevel = null;
        let isLaunchingPuzzle = false;

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getLevelNodeByNumber(number) {
            return document.querySelector(`.level-node[data-level="${number}"]`);
        }

        function getLevelStatus(node) {
            if (!node) return 'locked';
            if (node.classList.contains('locked')) return 'locked';
            if (node.classList.contains('completed')) return 'completed';
            return 'current';
        }

        function getCurrentLevelNumber() {
            const currentNode = document.querySelector('.level-node.current');
            return currentNode ? Number(currentNode.dataset.level) : null;
        }

        function getMaxLevelNumber() {
            const nodes = Array.from(document.querySelectorAll('.level-node'));
            return nodes.length ? Math.max(...nodes.map(node => Number(node.dataset.level))) : 10;
        }

        function playUnlockEffect(node) {
            return new Promise(resolve => {
                let finished = false;

                if (!node) {
                    resolve();
                    return;
                }

                node.classList.remove('unlock-effect');
                void node.offsetWidth;
                node.classList.add('unlock-effect');

                const fallback = setTimeout(() => {
                    if (finished) return;
                    finished = true;
                    node.removeEventListener('animationend', handleAnimationEnd);
                    node.classList.remove('unlock-effect');
                    resolve();
                }, 2000);

                const handleAnimationEnd = (event) => {
                    if (event.animationName !== 'unlockPulse') return;

                    if (finished) return;
                    finished = true;
                    node.classList.remove('unlock-effect');
                    node.removeEventListener('animationend', handleAnimationEnd);
                    clearTimeout(fallback);
                    resolve();
                };

                node.addEventListener('animationend', handleAnimationEnd);
            });
        }

        function moveHeroToNode(node) {
            if (!node) return;

            const circle = node.querySelector('circle');
            const hero = document.getElementById('hero-token');

            if (!circle || !hero) return;

            const cx = Number(circle.getAttribute('cx'));
            const cy = Number(circle.getAttribute('cy'));
            const offsetX = Number(hero.getAttribute('width')) / 2;
            const offsetY = Number(hero.getAttribute('height')) / 2;
            const verticalLift = 10;

            hero.setAttribute('x', cx - offsetX);
            hero.setAttribute('y', cy - offsetY - verticalLift);
            heroCurrentLevel = Number(node.dataset.level) || heroCurrentLevel;
        }

        function moveHeroToLevel(levelNumber) {
            const node = getLevelNodeByNumber(levelNumber);
            moveHeroToNode(node);
        }

        function buildTravelPath(startLevel, targetLevel) {
            if (!Number.isFinite(startLevel) || !Number.isFinite(targetLevel) || startLevel === targetLevel) {
                return [];
            }

            const step = startLevel < targetLevel ? 1 : -1;
            const path = [];

            for (let level = startLevel + step; step > 0 ? level <= targetLevel : level >= targetLevel; level += step) {
                path.push(level);
            }

            return path;
        }

        async function travelHeroToLevel(targetLevel) {
            const startingLevel = heroCurrentLevel || getCurrentLevelNumber() || 1;
            const path = buildTravelPath(startingLevel, targetLevel);

            if (!path.length) {
                moveHeroToLevel(targetLevel);
                return;
            }

            for (const level of path) {
                moveHeroToLevel(level);
                await wait(700);
            }
        }

        function persistLevelProgress(levelNumber) {
            localStorage.setItem(LEVEL_STORAGE_KEY, String(levelNumber));
        }

        function persistLastPlayedLevel(levelNumber) {
            localStorage.setItem(LAST_PLAYED_STORAGE_KEY, String(levelNumber));
        }

        function applyLevelProgress(targetCurrentLevel, options = {}) {
            const nodes = Array.from(document.querySelectorAll('.level-node'));

            nodes.forEach(node => {
                const level = Number(node.dataset.level);
                node.classList.remove('completed', 'current', 'locked');

                if (level < targetCurrentLevel) {
                    node.classList.add('completed');
                } else if (level === targetCurrentLevel) {
                    node.classList.add('current');
                } else {
                    node.classList.add('locked');
                }
            });

            const maxLevel = nodes.length ? Math.max(...nodes.map(node => Number(node.dataset.level))) : 10;
            const heroTargetLevel = Number.isFinite(options.heroLevelOverride)
                ? Math.min(Math.max(options.heroLevelOverride, 1), maxLevel)
                : targetCurrentLevel;
            const currentNode = getLevelNodeByNumber(heroTargetLevel);
            moveHeroToNode(currentNode);
            currentSelectedLevel = targetCurrentLevel;
        }

        function animateReturnFromGame(targetLevel, lastCompletedLevel) {
            const storedCompletion = Number(localStorage.getItem(LAST_COMPLETED_STORAGE_KEY));
            const completionLevel = Number.isFinite(lastCompletedLevel)
                ? lastCompletedLevel
                : (!Number.isNaN(storedCompletion) ? storedCompletion : null);
            const shouldAnimateUnlock = Number.isFinite(completionLevel) && targetLevel === completionLevel + 1;

            if (!Number.isNaN(storedCompletion)) {
                localStorage.removeItem(LAST_COMPLETED_STORAGE_KEY);
            }

            if (!shouldAnimateUnlock) return;

            const targetNode = getLevelNodeByNumber(targetLevel);
            const previousNode = getLevelNodeByNumber(targetLevel - 1);
            const storedTransitionEnd = Number(localStorage.getItem(TRANSITION_END_STORAGE_KEY));
            const remainingTransitionDelay = Number.isNaN(storedTransitionEnd)
                ? ADVENTURE_TRANSITION_DURATION_MS
                : Math.max(0, storedTransitionEnd - Date.now());

            if (!Number.isNaN(storedTransitionEnd)) {
                localStorage.removeItem(TRANSITION_END_STORAGE_KEY);
            }

            if (previousNode) {
                previousNode.classList.remove('current');
                previousNode.classList.add('completed');
                moveHeroToNode(previousNode);
            }

            if (targetNode) {
                targetNode.classList.remove('completed', 'current');
                targetNode.classList.add('locked');
            }

            setTimeout(() => {
                playUnlockEffect(targetNode)
                    .then(() => applyLevelProgress(targetLevel));
            }, remainingTransitionDelay);
        }

        function loadSavedProgress() {
            const nodes = Array.from(document.querySelectorAll('.level-node'));
            if (!nodes.length) return;

            const hero = document.getElementById('hero-token');
            const savedLevel = Number(localStorage.getItem(LEVEL_STORAGE_KEY));
            const lastCompletedLevel = Number(localStorage.getItem(LAST_COMPLETED_STORAGE_KEY));
            const lastPlayedLevel = Number(localStorage.getItem(LAST_PLAYED_STORAGE_KEY));
            const hasCompletedLevel = Number.isFinite(lastCompletedLevel);
            const defaultLevel = getCurrentLevelNumber() || 1;
            const maxLevel = Math.max(...nodes.map(node => Number(node.dataset.level)));
            const sanitizedLevel = Number.isNaN(savedLevel) || savedLevel < 1 ? defaultLevel : savedLevel;
            const validatedLevel = hasCompletedLevel
                ? Math.min(Math.max(sanitizedLevel, 1), maxLevel)
                : 1;
            const clampedCompletionLevel = Number.isFinite(lastCompletedLevel)
                ? Math.min(Math.max(lastCompletedLevel, 1), maxLevel)
                : null;
            const clampedLastPlayedLevel = Number.isFinite(lastPlayedLevel)
                ? Math.min(Math.max(lastPlayedLevel, 1), maxLevel)
                : null;
            const hasTransitionData = Number.isFinite(Number(localStorage.getItem(TRANSITION_END_STORAGE_KEY)));
            const isMapCompleted = hasCompletedLevel && lastCompletedLevel >= maxLevel;

            let heroStartingLevel;

            if (hasTransitionData && clampedCompletionLevel) {
                heroStartingLevel = clampedCompletionLevel;
            } else if (!hasTransitionData) {
                heroStartingLevel = isMapCompleted ? 1 : validatedLevel;
            } else if (clampedLastPlayedLevel) {
                heroStartingLevel = clampedLastPlayedLevel;
            } else {
                heroStartingLevel = isMapCompleted ? 1 : validatedLevel;
            }

            if (hero) {
                hero.classList.add('hero-token--no-transition');
            }

            moveHeroToLevel(heroStartingLevel);
            applyLevelProgress(validatedLevel, { heroLevelOverride: heroStartingLevel });
            animateReturnFromGame(validatedLevel, lastCompletedLevel);

            requestAnimationFrame(() => {
                if (hero) {
                    hero.classList.remove('hero-token--no-transition');
                }
            });
        }

        function completeCurrentLevel() {
            const currentNode = document.querySelector('.level-node.current');
            if (!currentNode) return;

            const currentLevel = Number(currentNode.dataset.level);
            currentNode.classList.remove('current');
            currentNode.classList.add('completed');
            persistLastPlayedLevel(currentLevel);

            const nextLevelNumber = currentLevel + 1;
            const nextNode = getLevelNodeByNumber(nextLevelNumber);

            if (nextNode) {
                nextNode.classList.remove('locked', 'completed');
                nextNode.classList.add('current');

                playUnlockEffect(nextNode).then(() => moveHeroToNode(currentNode));

                persistLevelProgress(nextLevelNumber);
                currentSelectedLevel = nextLevelNumber;
            } else {
                moveHeroToNode(currentNode);
                persistLevelProgress(currentLevel);
                currentSelectedLevel = currentLevel;
            }
        }

        function selectLevel(number, title, status) {
            const panel = document.getElementById('level-panel');
            const btn = document.getElementById('btn-action');
            const node = getLevelNodeByNumber(number);

            const resolvedStatus = status || getLevelStatus(node);
            currentSelectedLevel = number;

            btn.innerText = 'Jugar este nivel';
            btn.disabled = resolvedStatus === 'locked';
            btn.classList.toggle('btn-play--disabled', resolvedStatus === 'locked');

            panel.style.display = 'block';

            if (resolvedStatus !== 'locked') {
                startPuzzle();
            }
        }

        function launchPuzzleFromPath(number, title, status) {
            const node = getLevelNodeByNumber(number);
            const resolvedStatus = status || getLevelStatus(node);

            selectLevel(number, title, resolvedStatus);

            if (resolvedStatus === 'locked') {
                return;
            }

            startPuzzle();
        }

        async function startPuzzle() {
            const selectedNode = getLevelNodeByNumber(currentSelectedLevel);
            if (!currentSelectedLevel || !selectedNode || selectedNode.classList.contains('locked')) {
                return;
            }

            if (isLaunchingPuzzle) return;
            isLaunchingPuzzle = true;

            await travelHeroToLevel(currentSelectedLevel);

            persistLastPlayedLevel(currentSelectedLevel);
            const url = `../../adivina-la-palabra/game.html?mode=adventure&map=1&level=${currentSelectedLevel}`;
            window.location.href = url;
        }

        document.addEventListener('DOMContentLoaded', loadSavedProgress);
    </script>
</body>
</html>
